<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
	xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util"
	xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">

	<?include Includes.wxi?>

	<Package Name="$(var.Product)" Version="$(var.Version)" Manufacturer="$(var.Manufacturer)" Language="!(loc.ProductLanguage)" UpgradeCode="$(var.UpgradeCode)" Scope="perMachine">

		<SummaryInformation Keywords="Installer" Description="$(var.Description)" Codepage="!(loc.SummaryCodepage)" />

		<!--<PropertyRef Id="UpgradesFile" />-->
		
		<PropertyRef Id="AddRemovePropertiesFile" />

		<Media Id="1" Cabinet="cab1.cab" EmbedCab="yes" CompressionLevel="high" />
		<Icon Id="AppIcon" SourceFile="Resources\icon.ico" />

		<!-- User Interface -->
		<WixVariable Id="WixUILicenseRtf" Value="RustDesk License.rtf" />

		<ui:WixUI Id="WixUI_InstallDir" InstallDirectory="INSTALLFOLDER" />
		<UIRef Id="WixUI_ErrorProgressText" />

		<InstallUISequence>
			<!--<Custom Action="ReadCustomPathsFromExistingPathsFile" Before="CostFinalize" Condition="NOT Installed" />-->
			<Show Dialog="AnotherAppDialog" Before="WelcomeDlg" Condition="Not installed AND RUSTDESKNATIVEINSTALL AND Not RUSTDESKNATIVEINSTALLFOLDER"/>

		</InstallUISequence>

		<InstallExecuteSequence>
			<Custom Action="FirewallPortRemove" Before="InstallFinalize" Condition="REMOVE~=&quot;ALL&quot;" />
			<Custom Action="FirewallPortOutAdd" Before="InstallFinalize" Condition="NOT Installed" />
			<Custom Action="FirewallPortInAdd" Before="InstallFinalize" Condition="NOT Installed" />

			<!-- Launch ClientLauncher if installing or already installed and not uninstalling -->
			<Custom Action="LaunchApp" After="InstallFinalize" />
			<Custom Action="LaunchAppTray" After="InstallFinalize" />

			<InstallExecute After="RemoveExistingProducts" />

			<Custom Action="CloseProcesses" Before="RemoveFiles" />

		</InstallExecuteSequence>
		<CustomAction Id="LaunchApp" ExeCommand="" Return="asyncNoWait" FileRef="RustDesk.exe" />
		<CustomAction Id="LaunchAppTray" ExeCommand=" --tray" Return="asyncNoWait" FileRef="RustDesk.exe" />
		<CustomAction Id="CloseProcesses" ExeCommand='taskkill /F /IM "$(var.Product).exe"' Return="asyncNoWait" Directory="INSTALLFOLDER" />

		<MajorUpgrade DowngradeErrorMessage="!(loc.DowngradeError)" Schedule="afterInstallInitialize" AllowSameVersionUpgrades="yes" />

		<Feature Id="App" Level="1" AllowAdvertise="no" Display="expand" Title="!(loc.F_App)" Description="!(loc.F_App_Desc)" AllowAbsent="no">
			<ComponentGroupRef Id="Components" />

			<ComponentRef Id="Product.Registry.InstallDir" />
			<ComponentRef Id="Product.Registry.DefaultIcon" />
			<ComponentRef Id="Product.Registry.CommandPlay" />
			<ComponentRef Id="Product.Registry.URLProtocol" />
			<ComponentRef Id="Product.Registry.Command" />
			<ComponentRef Id="App.StartMenu" />
			<ComponentRef Id="Product.Registry.PersistedShortcutProperties" />
		</Feature>

		<!--https://wixtoolset.org/docs/tools/wixext/wixui/#customizing-a-dialog-set-->
		<!--$CustomBitmapsStart$-->
		<!--$CustomBitmapsEnd$-->
	</Package>
</Wix>
